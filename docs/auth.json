{
  "feature": "Authentication & Authorization",
  "description": "Sistema completo de autenticação com registro, login, logout e JWT. Inclui validação de dados, hash de senha com bcrypt, blacklist de tokens e gerenciamento de sessões",
  "baseUrl": "/api/v1/auth",
  "authentication": "Rotas /logout e /me requerem Bearer Token JWT no header Authorization",
  "routes": [
    {
      "name": "Registrar Usuário",
      "method": "POST",
      "path": "/register",
      "description": "Registra um novo usuário no sistema criando user e profile",
      "authentication": "Not Required",
      "headers": {
        "Content-Type": "application/json"
      },
      "body": {
        "username": "string (3-20 caracteres, apenas letras, números e underscore)",
        "name": "string (2-100 caracteres)",
        "email": "string (email válido, máx 255 caracteres)",
        "password": "string (6-10 caracteres)",
        "inviteCode": "string (opcional, máx 50 caracteres)"
      },
      "example": {
        "username": "joaosilva",
        "name": "João Silva",
        "email": "joao@example.com",
        "password": "senha123",
        "inviteCode": "CONVITE2024"
      },
      "validations": {
        "username": "^[a-zA-Z0-9_]+$ (sem espaços ou caracteres especiais)",
        "name": "Mínimo 2 caracteres",
        "email": "Deve ser email válido e único no sistema",
        "password": "Entre 6 e 10 caracteres",
        "inviteCode": "Opcional, validado se fornecido"
      },
      "response": {
        "success": true,
        "data": {
          "user": {
            "id": "uuid",
            "username": "joaosilva",
            "name": "João Silva",
            "email": "joao@example.com",
            "invite_code_used": "CONVITE2024",
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-15T10:30:00.000Z"
          },
          "profile": {
            "id": "uuid",
            "user_id": "uuid",
            "avatar_url": "",
            "banner_url": "",
            "bio": "",
            "signature": "",
            "total_posts": 0,
            "total_likes": 0,
            "ranking": 0,
            "level": 0,
            "role": "usuario",
            "is_banned": false,
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-15T10:30:00.000Z"
          },
          "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        },
        "message": "Usuário registrado com sucesso"
      },
      "notes": [
        "Password é hasheado com bcrypt (12 rounds) antes de salvar",
        "Profile é criado automaticamente com valores padrão",
        "Role padrão é 'usuario'",
        "Token JWT é gerado automaticamente após registro"
      ]
    },
    {
      "name": "Login",
      "method": "POST",
      "path": "/login",
      "description": "Autentica usuário e retorna token JWT",
      "authentication": "Not Required",
      "headers": {
        "Content-Type": "application/json"
      },
      "body": {
        "username": "string (obrigatório)",
        "password": "string (obrigatório)"
      },
      "example": {
        "username": "joaosilva",
        "password": "senha123"
      },
      "validations": {
        "username": "Não pode ser vazio",
        "password": "Não pode ser vazio"
      },
      "response": {
        "success": true,
        "data": {
          "user": {
            "id": "uuid",
            "username": "joaosilva",
            "name": "João Silva",
            "email": "joao@example.com",
            "invite_code_used": "CONVITE2024",
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-15T10:30:00.000Z"
          },
          "profile": {
            "id": "uuid",
            "user_id": "uuid",
            "avatar_url": "https://res.cloudinary.com/gtracker/image/upload/...",
            "banner_url": "https://res.cloudinary.com/gtracker/image/upload/...",
            "bio": "Desenvolvedor full-stack",
            "signature": "",
            "total_posts": 42,
            "total_likes": 156,
            "ranking": 1250,
            "level": 5,
            "role": "usuario",
            "is_banned": false,
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-20T14:20:00.000Z"
          },
          "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        },
        "message": "Login realizado com sucesso"
      },
      "notes": [
        "Senha é verificada usando bcrypt.compare",
        "Token JWT inclui userId e expira conforme configuração",
        "Retorna dados completos de user e profile"
      ]
    },
    {
      "name": "Logout",
      "method": "POST",
      "path": "/logout",
      "description": "Invalida o token JWT atual adicionando-o à blacklist",
      "authentication": "Required",
      "headers": {
        "Authorization": "Bearer {token}"
      },
      "response": {
        "success": true,
        "data": null,
        "message": "Logout realizado com sucesso"
      },
      "notes": [
        "Token é extraído do header Authorization",
        "Token é decodificado para obter userId e data de expiração",
        "Token é adicionado à tabela token_blacklist",
        "Tokens na blacklist são verificados em cada request autenticado",
        "Tokens expirados são automaticamente removidos da blacklist"
      ]
    },
    {
      "name": "Obter Usuário Atual (Me)",
      "method": "GET",
      "path": "/me",
      "description": "Retorna informações do usuário autenticado (user + profile)",
      "authentication": "Required",
      "headers": {
        "Authorization": "Bearer {token}"
      },
      "response": {
        "success": true,
        "data": {
          "user": {
            "id": "uuid",
            "username": "joaosilva",
            "name": "João Silva",
            "email": "joao@example.com",
            "invite_code_used": "CONVITE2024",
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-20T14:20:00.000Z"
          },
          "profile": {
            "id": "uuid",
            "user_id": "uuid",
            "avatar_url": "https://res.cloudinary.com/gtracker/image/upload/...",
            "banner_url": "https://res.cloudinary.com/gtracker/image/upload/...",
            "bio": "Desenvolvedor full-stack apaixonado por tecnologia",
            "signature": "https://res.cloudinary.com/gtracker/image/upload/...",
            "total_posts": 42,
            "total_likes": 156,
            "ranking": 1250,
            "level": 5,
            "role": "usuario",
            "is_banned": false,
            "created_at": "2024-01-15T10:30:00.000Z",
            "updated_at": "2024-01-20T14:20:00.000Z"
          }
        }
      },
      "notes": [
        "userId é extraído do token JWT via middleware authMiddleware",
        "Password hash nunca é retornado na response",
        "Útil para verificar sessão e obter dados atualizados do usuário"
      ]
    }
  ],
  "errorResponses": {
    "400": {
      "description": "Bad Request - Validação falhou",
      "examples": [
        {
          "success": false,
          "error": {
            "message": "Username deve ter no mínimo 3 caracteres",
            "code": "BAD_REQUEST"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Email inválido",
            "code": "BAD_REQUEST"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Senha deve ter no mínimo 6 caracteres",
            "code": "BAD_REQUEST"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Username deve conter apenas letras, números e underscore",
            "code": "BAD_REQUEST"
          }
        }
      ]
    },
    "401": {
      "description": "Unauthorized - Credenciais inválidas ou token inválido",
      "examples": [
        {
          "success": false,
          "error": {
            "message": "Credenciais inválidas",
            "code": "UNAUTHORIZED"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Token inválido ou expirado",
            "code": "UNAUTHORIZED"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Token foi invalidado (logout)",
            "code": "UNAUTHORIZED"
          }
        }
      ]
    },
    "404": {
      "description": "Not Found - Usuário não encontrado",
      "example": {
        "success": false,
        "error": {
          "message": "Usuário não encontrado",
          "code": "NOT_FOUND"
        }
      }
    },
    "409": {
      "description": "Conflict - Username ou email já existe",
      "examples": [
        {
          "success": false,
          "error": {
            "message": "Username já está em uso",
            "code": "CONFLICT"
          }
        },
        {
          "success": false,
          "error": {
            "message": "Email já está em uso",
            "code": "CONFLICT"
          }
        }
      ]
    }
  },
  "security": {
    "passwordHashing": "bcrypt com 12 rounds (BCRYPT_ROUNDS em .env)",
    "jwtAlgorithm": "HS256",
    "jwtExpiration": "Configurável via JWT_EXPIRES_IN (.env, ex: '7d', '24h')",
    "jwtSecret": "Configurável via JWT_SECRET (.env)",
    "tokenBlacklist": "Tokens invalidados são armazenados em token_blacklist até expiração",
    "authMiddleware": "Valida token JWT e verifica se não está na blacklist",
    "passwordValidation": {
      "minLength": 6,
      "maxLength": 10,
      "hashing": "bcrypt.hash antes de salvar no DB"
    },
    "usernameValidation": {
      "minLength": 3,
      "maxLength": 20,
      "pattern": "^[a-zA-Z0-9_]+$",
      "unique": true
    },
    "emailValidation": {
      "maxLength": 255,
      "format": "Email RFC 5322 válido",
      "unique": true
    }
  },
  "database": {
    "tables": [
      "users (id, username, name, email, password_hash, invite_code_used, created_at, updated_at)",
      "profiles (id, user_id, avatar_url, banner_url, bio, signature, total_posts, total_likes, ranking, level, role, is_banned, created_at, updated_at)",
      "token_blacklist (id, token, user_id, expires_at, created_at)"
    ],
    "constraints": [
      "users.username - UNIQUE",
      "users.email - UNIQUE",
      "profiles.user_id - FOREIGN KEY -> users.id",
      "token_blacklist.user_id - FOREIGN KEY -> users.id"
    ],
    "migrations": [
      "001_create_users_and_profiles.sql",
      "003_create_token_blacklist.sql"
    ]
  },
  "jwt": {
    "payload": {
      "userId": "UUID do usuário",
      "iat": "Timestamp de emissão (issued at)",
      "exp": "Timestamp de expiração (expiration)"
    },
    "header": {
      "alg": "HS256",
      "typ": "JWT"
    },
    "usage": "Authorization: Bearer {token}",
    "verification": "Decodificado e validado em authMiddleware",
    "expiration": "Configurável via JWT_EXPIRES_IN (ex: '7d' = 7 dias)"
  },
  "middleware": {
    "validate": {
      "description": "Valida request body contra schema Zod",
      "schemas": [
        "registerSchema - valida dados de registro",
        "loginSchema - valida dados de login"
      ],
      "usage": "validate(registerSchema) em route handler"
    },
    "authMiddleware": {
      "description": "Valida JWT e verifica blacklist",
      "flow": [
        "1. Extrai token do header Authorization",
        "2. Verifica se token é válido (assinatura e expiração)",
        "3. Verifica se token não está na blacklist",
        "4. Adiciona userId ao req.user",
        "5. Chama next() ou retorna 401"
      ],
      "usage": "authMiddleware em rotas protegidas"
    }
  },
  "setup": {
    "dependencies": [
      "bcrypt@5.1.1",
      "jsonwebtoken@9.0.2",
      "zod@3.22.4",
      "@types/bcrypt@5.0.2",
      "@types/jsonwebtoken@9.0.5"
    ],
    "environmentVariables": [
      "JWT_SECRET - Chave secreta para assinar tokens JWT",
      "JWT_EXPIRES_IN - Tempo de expiração do token (ex: '7d', '24h', '30m')",
      "BCRYPT_ROUNDS - Número de rounds do bcrypt (recomendado: 12)"
    ],
    "runMigrations": [
      "Execute 001_create_users_and_profiles.sql",
      "Execute 003_create_token_blacklist.sql"
    ],
    "configuration": [
      "Configure JWT_SECRET com valor seguro e aleatório",
      "Configure JWT_EXPIRES_IN conforme necessidade do negócio",
      "Configure BCRYPT_ROUNDS (12 é recomendado para produção)"
    ]
  },
  "flows": {
    "registration": [
      "1. Cliente envia POST /auth/register com dados do usuário",
      "2. Middleware validate verifica dados contra registerSchema",
      "3. authService verifica se username/email já existem",
      "4. Password é hasheado com bcrypt",
      "5. User e Profile são criados no banco",
      "6. Token JWT é gerado",
      "7. Retorna user (sem password), profile e token"
    ],
    "login": [
      "1. Cliente envia POST /auth/login com username e password",
      "2. Middleware validate verifica dados contra loginSchema",
      "3. authService busca user por username",
      "4. Password é comparado com hash usando bcrypt.compare",
      "5. Se válido, busca profile do usuário",
      "6. Token JWT é gerado",
      "7. Retorna user (sem password), profile e token"
    ],
    "logout": [
      "1. Cliente envia POST /auth/logout com token no header",
      "2. authMiddleware valida token",
      "3. Token é decodificado para obter userId e exp",
      "4. Token é adicionado à blacklist com expires_at",
      "5. Retorna sucesso"
    ],
    "authenticatedRequest": [
      "1. Cliente envia request com token no header Authorization",
      "2. authMiddleware extrai token",
      "3. Token é verificado (assinatura e expiração)",
      "4. Verifica se token não está na blacklist",
      "5. userId é extraído e adicionado a req.user",
      "6. Request prossegue para o controller"
    ]
  },
  "bestPractices": [
    "Nunca retorne password_hash nas responses",
    "Sempre use bcrypt para hash de senhas",
    "Configure JWT_SECRET com valor forte (min 32 caracteres aleatórios)",
    "Configure JWT_EXPIRES_IN apropriadamente (7d é razoável para apps web)",
    "Use BCRYPT_ROUNDS >= 12 em produção",
    "Sempre valide tokens em rotas protegidas",
    "Implemente token blacklist para logout seguro",
    "Limpe tokens expirados da blacklist periodicamente",
    "Use HTTPS em produção para proteger tokens em trânsito",
    "Armazene tokens de forma segura no cliente (httpOnly cookies ou localStorage com cuidado)"
  ],
  "notes": [
    "Token JWT contém apenas userId, não dados sensíveis",
    "Profile é criado automaticamente ao registrar usuário",
    "Role padrão de novos usuários é 'usuario'",
    "Tokens na blacklist são mantidos até expiração para evitar reuso",
    "authMiddleware adiciona req.user.userId para uso em controllers",
    "Password nunca é exposto em responses (removido via destructuring)",
    "Invite codes são opcionais no registro",
    "Username e email devem ser únicos no sistema"
  ]
}
